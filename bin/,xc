#!/bin/sh
### USAGE: ,xc [-h|--help] [-m] [CMD...]
### eXec and Copy to clipboard
###

usage() { grep '^###' "$0"  | sed 's/^### //g;'; }

should_use_color() {
  test -t 1 && # stdout (device 1) is a tty
  test -z "${NO_COLOR:-}" && # the NO_COLOR variable isn't set
  command -v tput >/dev/null 2>&1 # the `tput` command is available
}
if should_use_color; then
  gray="$(tput setaf 8)"
  reset="$(tput sgr0)"
else
  gray=""
  reset=""
fi

markdown=0
details=0
while [ -n "${1:-}" ]; do
  case "$1" in
    -h|--help) usage && exit 0;;
    -m|--markdown) markdown=1; shift;;
    -d|--details)  markdown=1; details=1; shift;;
    *) break;;
  esac
done

cmd="$*"
output=$(mktemp "${TEMP:-/tmp}/tmp.out.XXXXX")
{
    [ $details  = 1 ] && printf "<details open>\n\n"
    [ $markdown = 1 ] && printf '```sh\n'
    [ $markdown = 0 ] && printf "; "
    printf '%s\n' "$cmd"
    [ $markdown = 1 ] && printf '```\n```\n'
} >> "$output"
printf "%s" "$gray"
( eval "$cmd"; echo "=> $?" ) 2>&1 | sed 's/^/# /g' | tee -a "$output"
{
    [ $markdown = 1 ] && printf '```\n'
    [ $details  = 1 ] && printf "\n</details>\n"
}  >> "$output"
printf "%s" "$reset"

cat "$output" | copy
